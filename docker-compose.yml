version: "3.9"

x-restart: &restart unless-stopped

x-db-env: &db_env
  POSTGRES_USER: ${DB_USERNAME}
  POSTGRES_PASSWORD: ${DB_PASSWORD}
  POSTGRES_DB: postgres

x-backend-common-env: &backend_common_env
  SERVER_ADDRESS: "0.0.0.0"
  SERVER_PORT: "8080"

  # Shared cache DB
  CACHE_DATASOURCE_URL: jdbc:postgresql://${DB_HOST}:${DB_PORT}/${DB_NAME_CACHE}?tcpKeepAlive=true
  CACHE_DATASOURCE_USERNAME: ${DB_USERNAME}
  CACHE_DATASOURCE_PASSWORD: ${DB_PASSWORD}

  SEMS_ACCOUNT: ${SEMS_ACCOUNT}
  SEMS_PASSWORD: ${SEMS_PASSWORD}
  SEMS_STATION_ID: ${SEMS_STATION_ID}

  JWT_SECRET: ${JWT_SECRET}
  APP_ADMIN_EMAIL: ${APP_ADMIN_EMAIL:-admin@example.com}
  APP_ADMIN_PASSWORD: ${APP_ADMIN_PASSWORD}
  DEMO_SECRET: ${DEMO_SECRET}

x-backend-common: &backend_common
  restart: *restart
  depends_on:
    db:
      condition: service_healthy
  expose:
    - "8080"
  networks:
    - homewatts-net

x-frontend-common: &frontend_common
  restart: *restart
  networks:
    - homewatts-net
  labels:
    traefik.enable: "true"

x-sec-headers: &sec_headers_labels
  traefik.http.middlewares.sec-headers.headers.stsSeconds: "31536000"
  traefik.http.middlewares.sec-headers.headers.stsIncludeSubdomains: "true"
  traefik.http.middlewares.sec-headers.headers.stsPreload: "true"
  traefik.http.middlewares.sec-headers.headers.contentTypeNosniff: "true"
  traefik.http.middlewares.sec-headers.headers.frameDeny: "true"
  traefik.http.middlewares.sec-headers.headers.referrerPolicy: "no-referrer"

services:
  traefik:
    image: traefik:v3.1
    container_name: homewatts-traefik
    restart: *restart
    command:
      - --providers.docker=true
      - --providers.docker.exposedbydefault=false

      - --entrypoints.web.address=:80
      - --entrypoints.websecure.address=:443
      - --entrypoints.web.http.redirections.entryPoint.to=websecure
      - --entrypoints.web.http.redirections.entryPoint.scheme=https

      - --certificatesresolvers.le.acme.email=${ACME_EMAIL}
      - --certificatesresolvers.le.acme.storage=/letsencrypt/acme.json
      - --certificatesresolvers.le.acme.httpchallenge=true
      - --certificatesresolvers.le.acme.httpchallenge.entrypoint=web

      - --api.dashboard=false
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - traefik_letsencrypt:/letsencrypt
    networks:
      - homewatts-net
    labels:
      traefik.enable: "true"

  db:
    image: postgres:16
    container_name: homewatts-db
    restart: *restart
    environment: *db_env
    volumes:
      - /mnt/db/postgres_v1:/var/lib/postgresql/data
      - ./infrastructure/postgres:/docker-entrypoint-initdb.d:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -h 127.0.0.1 -p 5432 -U $$POSTGRES_USER -d $$POSTGRES_DB"]
      interval: 5s
      timeout: 3s
      retries: 20
      start_period: 20s
    networks:
      homewatts-net:
        aliases:
          - homewatts-db

  backend_prod:
    <<: *backend_common
    image: ghcr.io/markusdunkel/homewatts-backend:${IMAGE_TAG_PROD}
    container_name: homewatts-prod-be
    environment:
      <<: *backend_common_env
      SPRING_PROFILES_ACTIVE: prod
      SPRING_DATASOURCE_URL: jdbc:postgresql://${DB_HOST}:${DB_PORT}/${DB_NAME_PROD}?tcpKeepAlive=true
      SPRING_DATASOURCE_USERNAME: ${DB_USERNAME}
      SPRING_DATASOURCE_PASSWORD: ${DB_PASSWORD}

  backend_staging:
    <<: *backend_common
    image: ghcr.io/markusdunkel/homewatts-backend:${IMAGE_TAG_STAGING}
    container_name: homewatts-staging-be
    environment:
      <<: *backend_common_env
      SPRING_PROFILES_ACTIVE: staging
      SPRING_DATASOURCE_URL: jdbc:postgresql://${DB_HOST}:${DB_PORT}/${DB_NAME_STAGING}?tcpKeepAlive=true
      SPRING_DATASOURCE_USERNAME: ${DB_USERNAME}
      SPRING_DATASOURCE_PASSWORD: ${DB_PASSWORD}

  frontend_prod:
    <<: *frontend_common
    image: ghcr.io/markusdunkel/homewatts-frontend:${IMAGE_TAG_PROD}
    container_name: homewatts-prod-fe
    depends_on:
      - backend_prod
    environment:
      BACKEND_HOST: backend_prod
      BACKEND_PORT: 8080
    labels:
      <<: *sec_headers_labels
      traefik.enable: "true"
      traefik.http.routers.front-prod.rule: Host(`${APP_HOST}`)
      traefik.http.routers.front-prod.entrypoints: websecure
      traefik.http.routers.front-prod.tls: "true"
      traefik.http.routers.front-prod.tls.certresolver: le
      traefik.http.routers.front-prod.middlewares: sec-headers@docker
      traefik.http.services.front-prod.loadbalancer.server.port: "80"

  frontend_staging:
    <<: *frontend_common
    image: ghcr.io/markusdunkel/homewatts-frontend:${IMAGE_TAG_STAGING}
    container_name: homewatts-staging-fe
    depends_on:
      - backend_staging
    environment:
      BACKEND_HOST: backend_staging
      BACKEND_PORT: 8080
    labels:
      traefik.enable: "true"
      traefik.http.routers.front-staging.rule: Host(`${APP_HOST_STAGING}`)
      traefik.http.routers.front-staging.entrypoints: websecure
      traefik.http.routers.front-staging.tls: "true"
      traefik.http.routers.front-staging.tls.certresolver: le
      traefik.http.routers.front-staging.middlewares: sec-headers@docker
      traefik.http.services.front-staging.loadbalancer.server.port: "80"

  collector:
    <<: *backend_common
    image: ghcr.io/markusdunkel/homewatts-backend:${IMAGE_TAG_COLLECTOR:-${IMAGE_TAG_PROD}}
    container_name: homewatts-collector
    environment:
      SPRING_PROFILES_ACTIVE: collector

      SPRING_DATASOURCE_URL: jdbc:postgresql://${DB_HOST}:${DB_PORT}/${DB_NAME_PROD}?tcpKeepAlive=true
      SPRING_DATASOURCE_USERNAME: ${DB_USERNAME}
      SPRING_DATASOURCE_PASSWORD: ${DB_PASSWORD}

      CACHE_DATASOURCE_URL: jdbc:postgresql://${DB_HOST}:${DB_PORT}/${DB_NAME_CACHE}?tcpKeepAlive=true
      CACHE_DATASOURCE_USERNAME: ${DB_USERNAME}
      CACHE_DATASOURCE_PASSWORD: ${DB_PASSWORD}

      SEMS_ACCOUNT: ${SEMS_ACCOUNT}
      SEMS_PASSWORD: ${SEMS_PASSWORD}
      SEMS_STATION_ID: ${SEMS_STATION_ID}
    stop_grace_period: "30s"
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://127.0.0.1:8081/actuator/health || exit 1"]
      interval: 10s
      timeout: 3s
      retries: 6
      start_period: 15s

networks:
  homewatts-net:
    driver: bridge

volumes:
  traefik_letsencrypt:
